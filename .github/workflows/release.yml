name: Check Version and Release

on:
  schedule:
    - cron: '0 0 * * 1,3,5'
  workflow_dispatch:

jobs:
  check_version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'yarn'

      - name: Get Version from JSON
        run: |
          VERSION=$(curl -s https://d.defold.com/stable/info.json | jq -r .version)
          GIT_VERSION="v$VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "GIT_VERSION=$GIT_VERSION" >> $GITHUB_ENV

      - name: Check Tag and Release
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          if git rev-parse --verify --quiet "$GIT_VERSION"; then
            echo "Tag $GIT_VERSION already exists."
          else
            # Bump Version
            git config user.email "github@thinknathan.com"
            git config user.name "thinknathan"
            git remote set-url origin https://$PAT_TOKEN@github.com/$GITHUB_REPOSITORY
            npm --no-git-tag-version version $VERSION
            git add --all
            git commit -m "Bump version to $VERSION"
            git push

            # Build
            yarn
            yarn run build
            git add --all
            git commit -m "Build for Defold stable $GIT_VERSION"
            git push

            # Create Release
            git tag $GIT_VERSION
            git push origin $GIT_VERSION
            hub release create -m "Release $GIT_VERSION" $GIT_VERSION
          fi
